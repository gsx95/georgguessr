<html>
<head>
</head>
<body>
<data id="streetview-data"></data>
<script>

    function processRooms() {
        document.getElementById("streetview-data").setAttribute("status", "processing");
        var svService = new google.maps.StreetViewService();
        var positions = JSON.parse(getRequestParameter("pos")).pos;
        var count = positions.length;
        var readyCount = 0;
        for (var i = 0; i < count; i++) {
            var roundPos = positions[i];
            var round = roundPos.r;
            var pos = roundPos.p;
            getStreetViewForPos(svService, round, pos.lat, pos.lng, 0, function (round, panoId, latLng) {
                if(panoId == null) {
                    console.log("got no pano id for " + round);
                    document.getElementById("streetview-data").innerText += "," + JSON.stringify({r: round});
                    readyCount++;
                } else {
                    console.log("got pano id for " + round + " --> " + panoId);
                    document.getElementById("streetview-data").innerText += "," + JSON.stringify({r: round, id: panoId, location: latLng});
                    readyCount++;
                }
            });
        }
        function waitForProcessToFinish() {
            if (readyCount === count) {
                document.getElementById("streetview-data").setAttribute("status", "ready");
            } else {
                setTimeout(waitForProcessToFinish, 100);
            }
        }
        waitForProcessToFinish();
    }
    function getStreetViewForPos(svService, round, lat, lon, count, callback) {
        var searchRad = [50, 100, 500, 1000, 5000, 10000, 50000, 100000, 500000, 1000000, 5000000];
        svService.getPanorama({
            location: {"lat": lat, "lng": lon},
            "radius": searchRad[count],
            "source": "outdoor"
        }, function (data, status) {
            checkStreetView(data, status, function(data) {
                callback(round, data.location.pano, data.location.latLng.toJSON());
            }, function(errorMsg) {
                console.log("[" + round + "] failed on count " + count + " with msg " + errorMsg);
                if (count + 1 === searchRad.length) {
                    callback(round, null, null);
                } else {
                    getStreetViewForPos(svService, round, lat, lon, count + 1, callback);
                }
            });
        });
    }
    function getRequestParameter(parameterName) {
        var result = null, tmp = [];
        var items = location.search.substr(1).split("&");
        for (var index = 0; index < items.length; index++) {
            tmp = items[index].split("=");
            if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
        }
        return result;
    }

    function checkStreetView(data, status, okCallback, errorCallback) {
        if (status !== "OK" || data.links.length !== 2) {
            errorCallback("status or links wrong");
            return;
        }
        return okCallback(data);

        var latLng = data.location.latLng;
        var lat = latLng.lat();
        var lng = latLng.lng();
        var endpoint = "https://roads.googleapis.com/v1/snapToRoads?key=AIzaSyCGxNkbZJlq1H2onKSxmfb2XSJNvWw_Gj4&path=" + lat + "," + lng;


            // TODO: the following commented code checks if there is a nearby street within ~20m
            // enable this after implementing a logic to generate new random searching points after no fitting streetview could be found

         // fetchAsync(endpoint).then(function(response) {
         //   if(!response.hasOwnProperty('snappedPoints')) {
         //       errorCallback("did not snap to near street")
         //   } else {
         //       let streetLoc = response["snappedPoints"][0]["location"];
         //       let streetLat = streetLoc["latitude"];
         //       let streetLng = streetLoc["longitude"];

         //       let p1 = new google.maps.LatLng(lat, lng);
         //       let p2 = new google.maps.LatLng(streetLat, streetLng);

         //       let distance = google.maps.geometry.spherical.computeDistanceBetween(p1, p2);

         //       if(distance < 20){
         //           okCallback(data);
         //       }

    }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=<%= MAPS_KEY %>&callback=processRooms&libraries=drawing,places" defer></script>
</body>
</html>